<!DOCTYPE html>
<html>

<head>
  <link rel='stylesheet' href='/stylesheets/style.css'>
  <!-- setup Title Tab -->
  <title>
    <%= tabtitle %>
  </title>
  <!-- load debug script -->
  <script type="text/javascript" src="/javascripts/debug_browserify.js"></script>
  <!-- load jQUery -->
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <!-- load functions -->
  <script type="text/javascript">
    function pagestate_ctrl(pagestate_in) {
      var show_page = '#' + pagestate_in
      var hide_page = 'div:not(#' + pagestate_in + ')'
      $(show_page).show()
      $(hide_page).hide()
      $("#banner_image").show()
    }

    function pagestate_alloff() {
      $('div:not(#0)').hide()
      $("#banner_image").show()
    }

    function timedRefresh(timeoutPeriod) {
      setTimeout("location.reload(true);", timeoutPeriod);
    }
  </script>
  <!-- load documentReady jQuery methods -->
  <script>
    $(document).ready(function() {

      localStorage.debug = 'process:debug_datain;debug_setup'
      debug_datain = debug('process:debug_datain');
      debug_setup = debug('process:debug_setup');
      debug_display = debug('process:debug_display');

      // array to store the image-URLS
      var urls = []
      // array to stores a time-marker per image-URL
      var markers = []
      //array index for currently-displayed image from url-array
      var url_index;
      // length of video
      var vid_duration;
      // display-duration for each image-url in the array
      var pic_duration;
      // define time-regions for pop-up-title, text-display, image-display
      var popupStart = 6.23;
      var popupEnd = 11.21;
      // time-period during which popup-title is displayed
      var popup_duration = popupEnd - popupStart;
      var imagesStart = 17.13;
      var imagesEnd = 41.11;
      // time-period during which images/story are displayed
      var image_duration = imagesEnd - imagesStart;

      // on startup metadata save vid_duration
      var vid = document.getElementById("videoPlayer");
      vid.onloadedmetadata = function() {
        debug_setup('First Page Visit');

        var mode = 'dev'; // otherwise set mode = 'prod'
        // parse returned JSON from database
        var data = <%-JSON.stringify(data)%>;
        debug_datain(data);
        var title = data.title;
        var story = data.story;
        var content = data.content;
        debug_datain("Title:" + title + '\n' + 'Story:' + story)

        // pass title/story text into innerHTML
        document.getElementById("popup_title_text").innerHTML = title;
        document.getElementById("panel_story_text").innerHTML = story;
        document.getElementById("scroller").innerHTML = story;

        // load all image-urls into an array
        for (var key in content) {
          urls.push(content[key]);
          debug_datain(content[key]);
        }

        // calculate durations/periods
        pic_duration = image_duration / urls.length;
        vid_duration = vid.duration;
        debug_setup("Meta data loaded... video_duration:" + vid_duration + ' pic_duration:' + pic_duration);

        // populate the marker-array with durations/periods/timecodes
        for (i = 1; i <= urls.length; i++) {
          markers.push(imagesStart + pic_duration * i);
          debug_setup('marker: ' + markers[i - 1]);
        }
        debug_setup('No of image: ' + urls.length);

        // load the first image-URL picture
        url_index = 0
        debug_display('loading the first image: ' + urls[url_index]);;
        document.getElementById("image").src = urls[url_index];
      };

      // during playback report currenttime
      $("#videoPlayer").on("timeupdate", function(event) {
        debug_display('currentTime: ' + this.currentTime)
        var currentTime = this.currentTime;
        if (currentTime >= markers[url_index]) {
          url_index++;
          if (url_index < urls.length) {
            debug_display('New url_index: ' + url_index)
            document.getElementById("image").src = urls[url_index];
          }
        }
        if (currentTime <= popupStart) {
          $("#popup_title").hide()
          $("#image").hide()
          $("#panel_story").hide()
          $("#panel_title").hide()
          //
          //this.currentTime = 7.0;
          //this.currentTime = 16.0;
          //
        } else if (currentTime >= popupStart && currentTime <= popupEnd) {
          $("#popup_title").show()
        } else if (currentTime >= imagesStart && currentTime <= imagesEnd) {
          // display main_titlein panel
          //$("#image_frame").show()
          $("#image").show()
          $("#scroller_div").show()
        } else {
          $("#popup_title").hide()
          $("#image_frame").hide()
          $("#image").hide()
          $("#panel_story").hide()
          $("#panel_title").hide()
          $("#scroller_div").hide()
        }
      });

      // detect when video-playback complete.. if true request new-story db-data
      $("#videoPlayer").on("ended", function(event) {
        debug_display('video ended... seeking new db-data ')
        //location.reload(true);
        //window.location.reload(true);
        $.get("request_new_story", function(data, status) {
          debug_setup('Refreshed Page');
          debug_datain(data);

          // on-re-start metadata save vid_duration
          var vid = document.getElementById('videoPlayer');
          vid.onloadedmetadata = function() {

            //reset arrays
            urls = []
            markers = []

            // parse in data
            title = data.title;
            story = data.story;
            content = data.content;
            debug_datain("New title:" + title + '\n' + 'New story:' + story)

            // pass title/story text into innerHTML
            document.getElementById("popup_title_text").innerHTML = title;
            document.getElementById("panel_story_text").innerHTML = story;
            document.getElementById("scroller").innerHTML = story;

            // load all image-urls into an array
            for (var key in content) {
              urls.push(content[key]);
              debug_datain(content[key]);
            }

            // calculate durations/periods
            pic_duration = image_duration / urls.length;
            vid_duration = vid.duration;
            debug_setup("Meta data loaded... video_duration:" + vid_duration + ' pic_duration:' + pic_duration);

            // populate the marker-array with durations/periods/timecodes
            for (i = 1; i <= urls.length; i++) {
              markers.push(imagesStart + pic_duration * i);
              debug_setup('marker: ' + markers[i - 1]);
            }
            debug_setup('No of image: ' + urls.length);

            // load the first image-URL picture
            url_index = 0
            debug_display('loading the first image: ' + urls[url_index]);
            document.getElementById("image").src = urls[url_index];
          };

          //restart video
          vid.currentTime = 0;
          vid.load();

        });
      });
    });
  </script>



</head>

<body>
  <!-- fullscreen scripts -->
  <script src="/screenfull/dist/screenfull.js"></script>
  <script>
    $(function() {
      $('#popup_title').click(function() {
        debug_setup('click')
        screenfull.toggle($('#videoPlayer')[0]);
        //screenfull.toggle($('#videoContainer')[0]);
        //screenfull.toggle($('#videoPlayer')[0]);
        //screenfull.toggle($('#videoMessage')[0]);
      });

      function fullscreenchange() {
        var elem = screenfull.element;
        $('#status').text('Is fullscreen: ' + screenfull.isFullscreen);
        if (elem) {
          $('#element').text('Element: ' + elem.localName + (elem.id ? '#' + elem.id : ''));
        }
        if (!screenfull.isFullscreen) {
          $('#external-iframe').remove();
          document.body.style.overflow = 'auto';
        }
      }
      screenfull.on('change', fullscreenchange);
      // Set the initial values
      fullscreenchange();
    });
  </script>

  <!-- video block... blue outline-colour  to mute add attr: muted controls="false"  -->
  <div id="videoContainer" class="video_container">

    <video id="videoPlayer" class="video_player" preload="metadata" autoplay="true" controls> video not supported
        <source src="/videos/aljazeera-desktop.m4v"></source>
        </video>

    <!-- overlays -->
    <div id="videoOverlays" class="video_overlays">

      <!-- image frame outline -->
      <div id="image_frame" style="display:none">
      </div>

      <!-- popup title text -->
      <div id="popup_title" style="display:none">
        <p id="popup_title_text">Default popup-title text... </p>
      </div>

      <!-- panel title story -->
      <div id="panel_story" style="display:none">
        <p id="panel_story_text">Default panel-story text... </p>
      </div>

      <!-- image url overlays -->
      <img id="image" style="display:none" />
      <!-- scrolling text overlay -->
      <div id="scroller_div" class="scroll-left" style="display:none">
        <p id="scroller">Default scrolling story text... </p>
      </div>
      <!-- end overlays -->
    </div>

    <!-- end video block -->
  </div>

</body>

</html>
